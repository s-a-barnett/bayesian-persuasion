---
title: "R Notebook"
output: html_notebook
---

# Import data & packages

```{r}
library(tidyverse)
library(tidyboot)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(coda)
library(here)
```

# Section 1: descriptive analyses

## Import behavioral data 

```{r}
d_raw <- read_csv('../data/prolificData.csv') %>%
  select(iterationName, gameid,rt,agent1stick,agent2stick,button_pressed,
         response,stimulus_type,stimulus_contestant,chosenStick,responses) %>%
  filter(!is.na(stimulus_type))
```

## Implement exclusions, get descriptive stats

```{r}
complete_games <- d_raw %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid)

cat(length(unique(d_raw$gameid)))
cat(length(complete_games), 'participants completed both isLong trials \n')

passed_manip_check <- d_raw %>%
  filter(gameid %in% complete_games) %>%
  filter(stimulus_type == 'bias') %>%
  select(stimulus_contestant, response, gameid, agent1stick) %>%
  spread(stimulus_contestant, response) %>%
  filter(first >= 50 & second <= 50) %>%
  pull(gameid) %>%
  unique()

cat(length(passed_manip_check), 'participants passed bias manipulation check \n')

# passed_rt_criterion <- d_raw %>%
#   filter(stimulus_type == 'isLong') %>%
#   mutate(log_rt = log(rt),
#          lower = mean(log_rt) - 2*sd(log_rt),
#          upper = mean(log_rt) + 2*sd(log_rt)) %>%
#   filter(log_rt > lower, log_rt < upper) %>%
#   # filter(rt > 8000, rt < 40000) %>%
#   group_by(gameid) %>%
#   tally() %>%
#   filter(n == 2) %>%
#   pull(gameid) %>%
#   unique()
# 
# cat(length(passed_rt_criterion), 'participants passed RT exclusion \n')
cat(length(passed_manip_check), 'of those participants passed attention check \n')

d <- d_raw %>%
  filter(gameid %in% passed_manip_check)
```

# Plot change in belief

## Inspect frequency of different sequences on speaker trials

```{r}
speaker_criterion <- d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, button_pressed, gameid) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, button_pressed) 
```

```{r}
d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter((gameid %in% passed_manip_check)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, gameid, chosenStick) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, chosenStick) %>%
  group_by(first) %>%
  tally() %>%
  arrange(-n)
```

```{r}
d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter((gameid %in% passed_manip_check)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, gameid, chosenStick) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, chosenStick) %>%
  unite(sequence, first, second, third, fourth) %>%
  group_by(sequence) %>%
  tally() %>%
  arrange(-n)
```

```{r}
d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(first = ifelse(first < 2, 2, first)) %>%
  mutate(first = paste0('showed stick ', first, ' first')) %>%
  group_by(agent1stick, first) %>%
  tidyboot::tidyboot_mean(response) %>%
  ggplot(aes(x = agent1stick, y = empirical_stat)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    geom_abline(intercept = 0, slope = 100, linetype = 'dotted') +
    ggthemes::theme_few() +
    labs(x = 'agent 1 stick length', y = 'belief about mean') +
    facet_wrap(~ first) +
    guides(color=FALSE) +
    theme(aspect.ratio = 1.5) +
    xlim(0.5,1)+
    ylim(0,100)

ggsave('speaker_dependence.pdf', units = 'in', height = 4, width = 8)
```


## Statistics

```{r}
# This seems like the most obvious way to run the regression...?
d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(first = ifelse(first < 2, 2, first),
         first = first - 3,
         agent1stick = 10 * (agent1stick - .5)) %>%
  lm(response ~ agent1stick * first, data = .) %>%
  summary()
```


## Examine post-test values

```{r}
d_raw %>%
  left_join(speaker_criterion) %>%
  filter(stimulus_type %in% c('2afc', 'meanSlider')) %>%
  mutate(response = ifelse(is.na(response), button_pressed, response)) %>%
  mutate(first = ifelse(first < 2, 2, first)) %>%
  select(-chosenStick, -responses, -button_pressed, -rt) %>%
  arrange(gameid) %>%
  pivot_wider(names_from = stimulus_type, values_from = response) %>%
  ggplot(aes(x = as.factor(`2afc`), y = meanSlider, group = as.factor(`2afc`), color = meanSlider >= 50)) +
    geom_jitter(alpha = 0.25, height = 0, data = . %>% filter(`2afc` == 0 & meanSlider <= 50)) +
    geom_jitter(alpha = 0.25, height = 0, data = . %>% filter(`2afc` == 1 & meanSlider >= 50)) +
    geom_jitter(data = . %>% filter(`2afc` == 0 & meanSlider > 50), color = 'black') +
    geom_jitter(data = . %>% filter(`2afc` == 1 & meanSlider < 50), color = 'black') +
    facet_wrap(~ as.factor(first)) +
    theme_few()
```

```{r}
d %>%
  left_join(speaker_criterion) %>%
  filter(stimulus_type %in% c('2afc', 'meanSlider')) %>%
  group_by(gameid, stimulus_type) %>%
  mutate(response = ifelse(is.na(response), button_pressed, response)) %>%
  select(-chosenStick, -responses, -button_pressed, -rt) %>%
  arrange(gameid) %>%
  pivot_wider(names_from = stimulus_type, values_from = response) %>%
  group_by(`2afc`, meanSlider > 50) %>%
  tally()
```

## Examine second stick

```{r}
beliefChange.d <- d %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  select(stimulus_contestant, agent1stick, agent2stick, gameid, response) %>%
  spread(stimulus_contestant, response) %>%
  mutate(diff = second - first)

ref.points <- data.frame(agent1stick = c(rep(seq(.5, .9, .1), 3), rep(.5, 15)),
                         agent2stick = c(rep(.5, 15), rep(seq(.1, .5, .1), 3)),
                         speaker_pref = rep(c(rep(2, 5), rep(3, 5), rep(4, 5)), 2),
                         empirical_stat = 50)

beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  mutate(speaker_pref = ifelse(speaker_pref < 2, 2, speaker_pref)) %>%
  group_by(agent1stick,  agent2stick, speaker_pref) %>%
  #filter(speaker_pref == 4) %>%
  tidyboot::tidyboot_mean(second) %>%
  bind_rows(ref.points) %>%
  
  ggplot(aes(x = fct_rev(factor(agent2stick)), y = fct_rev(factor(agent1stick)), fill = empirical_stat)) +
    geom_tile() +
    facet_grid( ~ speaker_pref) +
    ggthemes::theme_few() +
    theme(aspect.ratio = 1) +
    labs(x = 'agent 2 stick length', y = 'absolute belief')
```

Absolute change in belief (anything above 0, i.e. adjusting belief in direction of 'long' after seeing evidence consistent with 'short', is weak evidence effect) by speaker (broken)

```{r}
beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  group_by(agent1stick, agent2stick, speaker_pref) %>%
  filter(speaker_pref == 4) %>%
  tidyboot::tidyboot_mean(diff) %>%
  ggplot(aes(x = agent2stick, y = empirical_stat)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_smooth(method = 'lm', color = 'red', fullrange = TRUE) +
    ylim(-100, 50) + 
    xlim(0, 0.5) + 
    geom_hline(yintercept = 0, linetype = 'dotted') +
    geom_line(data=(d_model %>% filter(judge == 'J1') %>% filter(agent1stick %in% c(0.6, 0.7, 0.8, 0.9))), aes(x=agent2stick, y=delta_percent, color=agentBias, group=agentBias)) + 
    facet_grid(nSticks ~ agent1stick) +
    ggthemes::theme_few() +
    labs(x = 'agent 2 stick length', y = 'absolute change in belief')
```


## Write out for model input

```{r}
# d_cs <- d %>%
#   filter(stimulus_type == 'speakerTrial') %>%
#   filter(stimulus_contestant == 'first') %>%
#   mutate(firstStick = as.numeric(substring(chosenStick, 0, 1)) / 10) %>%
#   select(gameid, firstStick) 

# d %>%
#   filter(stimulus_type == 'isLong') %>%
#   filter(stimulus_contestant == 'first') %>%
#   mutate(adjResponse = case_when(response == 100 ~ 99,
#                                 response == 0 ~ 1,
#                                 TRUE ~ response)) %>%
#   mutate(belief = adjResponse / 100) %>%
#   select(gameid, agent1stick, belief) %>%
#   left_join(d_cs) %>%
#   select(gameid, agent1stick, belief, firstStick) %>%
#   write_csv(., "../stickgame/webppl-src/model-comparison/data/rsa-het-data.csv")
```

# Section 2: Model-based analyses

## Derive MAP beliefs & CIs from predictives file

```{r}
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

HPDhi<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

HPDlo<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

d_het_n24 <- read_csv(here("../models/model-comparison/data/rsa-het-data_no0.2_0.4.csv"))

# predictive <- read_csv(here("analysis/rsa-pp-params-posterior.csv"))
predictive_rsa <- read_csv("../stickgame/webppl-src/model-comparison/results/rsa-pp-params-posterior.csv")
# predictive_mas <- read_csv("../stickgame/webppl-src/model-comparison/results/cluster/results/run14/mas-pp-params-posterior.csv")
predictive_mas <- read_csv("../stickgame/webppl-src/model-comparison/results/mas-pp-params-posterior_new.csv")
```

Make individual histogram for each participant

```{r}
predictive_mas %>% 
  gather(gameid, value, -prob, -X1) %>%
  ggplot(aes(x = value)) +
    geom_histogram() +
    facet_wrap(~ gameid)

ggsave('predictiveHistograms.pdf', height = 20, width = 20, units = 'in')
```

Make scatter plot of MAP estimate and empirical belief for each individual

```{r}
predictive %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  ggplot(aes(x = MAPmodel, y = belief)) +
    geom_point() +
    geom_abline(intercept = 0, slope = 1) +
    facet_grid(agent1stick ~ firstStick) +
    xlim(0,1) +
    ylim(0,1)

```

```{r}
d_notbystick <- d_het_n24 %>%
  group_by(agent1stick) %>%
  tidyboot::tidyboot_mean(belief)

ggplot() +
  geom_point(data=d_notbystick, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_notbystick, aes(x=agent1stick, ymin=ci_lower, ymax=ci_upper), width=0) +
  geom_hline(yintercept=0.5, linetype='dotted') + 
  # facet_grid( ~ firstStick) +
  ggthemes::theme_few() + 
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.6, 0.9) + 
  ylim(0, 1)
```

summarize means for each condition

```{r}
d_rsa_pp <- predictive_rsa %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(MAPmodel) %>%
  mutate(group = 'rsa')

d_mas_pp <- predictive_mas %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(MAPmodel) %>%
  mutate(group = 'mas')

d_bystick <- d_het_n24 %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(belief) %>%
  mutate(group = 'actual')

# ggplot() +
#   geom_point(data=d_bystick, aes(x=agent1stick, y=empirical_stat)) +
#   geom_errorbar(data=d_bystick, aes(x=agent1stick, ymin=ci_lower, ymax=ci_upper), width=0) +
#   geom_hline(yintercept=0.5, linetype='dotted') + 
#   facet_grid( ~ firstStick) +
#   ggthemes::theme_few() + 
#   labs(x = 'agent 1 stick length', y = 'belief about mean') +
#   xlim(0.6, 0.9) + 
#   ylim(0, 1)

d_ppcomp <- d_bystick %>%
  full_join(d_rsa_pp) %>%
  full_join(d_mas_pp)
```

```{r}
pd <- position_dodge(0.4)

ggplot(d_ppcomp, aes(x=agent1stick, y=empirical_stat, colour=group)) + 
  scale_color_manual(values=c('black', 'red', 'blue')) +
  geom_point(position=pd) + 
  # scale_size_manual(values=c(10, 1, 1)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), position=pd, size=0.7, width=0) + 
  geom_hline(yintercept=0.5, linetype='dotted') + 
  geom_line(data = full_join(d_rsa_pp, d_mas_pp)) +
  facet_grid( ~ firstStick) +
  ggthemes::theme_few() + 
  labs(x = 'judge stick', y = 'belief about mean') +
  xlim(5.5, 9.5) + 
  scale_y_continuous(breaks=seq(0, 1.1, 0.1), limits = c(0, 1))

# ggsave("ppcheck.png", plot = p1, width = 8, height = 4)
```


```{r}
# ggplot() +
#   geom_point(data=d_all, aes(x=agent1stick, y=empirical_stat)) +
#   geom_errorbar(data=d_all, aes(x=agent1stick, ymin = ci_lower, ymax = ci_upper), width = 0) +
#   geom_hline(yintercept = 0.5, linetype = 'dotted') +
#   geom_line(data=(model_beliefs), aes(x=stick, y=belief)) +
#   facet_grid( ~ level) + 
#   ggthemes::theme_few() +
#   labs(x = 'agent 1 stick length', y = 'belief about mean') +
#   xlim(0.6,0.9)+
#   ylim(0,1)
```


# Import model data

```{r}
d_model <- read_csv('../stickgame/webppl-src/sim6/results-summary.csv') %>%
  mutate(percent_isLong_1 = 100 * p_isLong_1) %>%
  mutate(percent_isLong_2 = 100 * p_isLong_2) %>%
  mutate(delta_percent = percent_isLong_2 - percent_isLong_1) %>%
  rename(agent1stick = stick1, agent2stick = stick2)
```

# Plot human-model comparison

```{r}
d_stick4 <- d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  group_by(agent1stick, first) %>%
  tidyboot::tidyboot_mean(response) %>%
  filter(first == 4)

ggplot() + 
  geom_point(data=d_stick4, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_stick4, aes(x=agent1stick, ymin = ci_lower, ymax = ci_upper), width = 0) +
  geom_hline(yintercept = 50, linetype = 'dotted') +
  geom_line(data=(d_model %>% filter(judge == 'J1')), aes(x=agent1stick, y=percent_isLong_1, color=agentBias, group=agentBias)) + 
  facet_grid(~ nSticks) + 
  ggthemes::theme_few() +
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.5,1)+
  ylim(0,100)

```

# Filtered human-model comparison

```{r}
ggplot() + 
  geom_point(data=d_stick4, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_stick4, aes(x=agent1stick, ymin = ci_lower, ymax = ci_upper), width = 0) +
  geom_hline(yintercept = 50, linetype = 'dotted') +
  geom_line(data=(d_model %>% filter(judge == 'J1') %>% filter(nSticks == 3) %>% filter(agentBias == 5)), aes(x=agent1stick, y=percent_isLong_1), color="blue") + 
  geom_line(data=(d_model %>% filter(judge == 'J0') %>% filter(nSticks == 5)), aes(x=agent1stick, y=percent_isLong_1), color="red") + 
  ggthemes::theme_few() +
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.5,1) +
  ylim(0,100) + 
  ggtitle('Sceptics')
```

```{r}
d_stick3 <- d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  group_by(agent1stick, first) %>%
  tidyboot::tidyboot_mean(response) %>%
  filter(first == 3)

ggplot() + 
  geom_point(data=d_stick3, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_stick3, aes(x=agent1stick, ymin = ci_lower, ymax = ci_upper), width = 0) +
  geom_hline(yintercept = 50, linetype = 'dotted') +
  geom_line(data=(d_model %>% filter(judge == 'J0')), aes(x=agent1stick, y=percent_isLong_1)) + 
  ggthemes::theme_few() +
  facet_grid(~ nSticks) +
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.5,1)+
  ylim(0,100)

```

# Filtered human-model comparison

```{r}
ggplot() + 
  geom_point(data=d_stick3, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_stick3, aes(x=agent1stick, ymin = ci_lower, ymax = ci_upper), width = 0) +
  geom_hline(yintercept = 50, linetype = 'dotted') +
  geom_line(data=(d_model %>% filter(judge == 'J1') %>% filter(nSticks == 3) %>% filter(agentBias == 5)), aes(x=agent1stick, y=percent_isLong_1), color="blue") + 
  geom_line(data=(d_model %>% filter(judge == 'J0') %>% filter(nSticks == 5)), aes(x=agent1stick, y=percent_isLong_1), color="red") + 
  ggthemes::theme_few() +
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.5,1) +
  ylim(0,100) + 
  ggtitle('Naïfs')
```



# Supplemental: examine survey responses
```{r}
wee_criterion <- d %>%
  filter((gameid %in% complete_games)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, button_pressed, gameid) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, button_pressed) %>%
  filter(first %in% c(4)) %>%
  pull(gameid) %>%
  unique()

survey_reponses <- d %>%
  filter(gameid %in% wee_criterion) %>%
  filter(stimulus_type %in% c('speakerSurvey', 'judgeSurvey', 'exit_survey')) %>%
  filter(responses != '{"Q0":""}') %>%
  filter(!grepl("no", responses, ignore.case = TRUE)) %>%
  filter(!grepl("n/a", responses, ignore.case = TRUE)) %>%
  filter(!grepl("Sam", responses)) %>%
  # mutate(answer = substr(responses, 7, 100)) %>%
  select(gameid, stimulus_type, responses) %>%
  arrange(gameid)
```

# Supplemental: examine trial-level response time distribution

```{r}
d %>%
  filter(stimulus_type== 'isLong') %>%
  group_by(gameid, stimulus_type) %>%
  summarize(rt = mean(rt)) %>%
  ggplot(aes(x = rt)) +
    geom_histogram() +
    theme_bw() +
    geom_vline(xintercept = 5000) +
    xlim(4000, 50000)
```

#Supplemental: plot generative model histograms

```{r}
d %>%
  filter(gameid %in% complete_games) %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type == 'genModel') %>%
  filter(agent2stick == 0.6) %>%
  mutate(genStick = button_pressed + 1) %>%
  ggplot(aes(genStick)) + 
    geom_histogram() + 
    scale_x_continuous(name="stick length", breaks=0:10, limits=c(0, 10))
```

#Supplemental: plot generative model histograms

```{r}
d %>%
  filter(gameid %in% complete_games) %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type == 'genModel') %>%
  filter(agent2stick == 0.6) %>%
  mutate(genStick = button_pressed + 1) %>%
  filter(genStick > 6)

d %>%
  filter(gameid == '8834-a8a77fcd-2ed5-41cc-acd1-52c71e21c4e3') %>%
  filter(stimulus_type == 'isLong')
```

# Supplemental: examine 2afc vs. point estimate

```{r}
d %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type %in% c('2afc', 'meanSlider')) %>%
  arrange(gameid)
  #filter(((button_pressed == 0) & (response < 50)) | ((button_pressed == 1) & (response >= 50)))
```
