---
title: "R Notebook"
output: html_notebook
---

# Import data & packages

```{r}
library(tidyverse)
library(tidyboot)
library(lme4)
library(here)
library(lmerTest)
library(broom.mixed)
library(ggthemes)
library(coda)
library(xtable)
library(here)
```

## Import behavioral data 

```{r}
d_raw <- read_csv(here('data/replication.csv'), show_col_types = FALSE) %>%
  select(iterationName, gameid,rt,agent1stick,agent2stick,button_pressed,
         response,stimulus_type,firstContestant,stimulus_contestant,chosenStick,responses) %>%
  rename(long_stick = agent2stick, short_stick = agent1stick) %>%
  mutate(first_observation = ifelse(firstContestant == 'short', short_stick, long_stick),
         second_observation = ifelse(firstContestant == 'short', long_stick, short_stick)) %>%
  filter(!is.na(stimulus_type)) 
```

## Implement exclusions, get descriptive stats

```{r}
complete_games <- d_raw %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid)

internally_consistent <- d_raw %>%
  filter(gameid %in% complete_games) %>%
  filter(stimulus_type %in% c('bias', 'speakerTrial', 'isLong', '2afc', 'meanSlider', 'genModel')) %>%
  unite(col = stimulus_type, stimulus_type, stimulus_contestant) %>%
  mutate(response = ifelse(is.na(response), button_pressed, response),
         stimulus_type = gsub('_NA', '', stimulus_type)) %>%
  select(gameid, firstContestant, stimulus_type, first_observation, second_observation, response) %>%
  spread(stimulus_type, response) %>%
  filter(!is.na(genModel_fifth)) %>%
  mutate(passedBias = ifelse(firstContestant == 'long', 
                             bias_first >= 45 & bias_second <= 55, 
                             bias_first <= 45 & bias_second >= 55))

passedBiasCheck <- internally_consistent %>% filter(passedBias) %>% pull(gameid)

cat('of', d_raw %>% filter(stimulus_type == 'speakerTrial') %>% pull(gameid) %>% unique() %>% length(), 'participants who passed the quiz\n')
cat(length(complete_games), 'participants completed both isLong trials \n')
cat(length(passedBiasCheck), 'participants passed bias manipulation check \n')

d <- d_raw %>%
  filter(gameid %in% passedBiasCheck) 
```

# Results

## Behavioral results

### Report frequency of different sequences on speaker trials

```{r}
speaker_criterion <- d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, button_pressed, gameid) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, button_pressed) 

d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter((gameid %in% passedBiasCheck)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(firstContestant, stimulus_contestant, gameid, chosenStick) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, chosenStick) %>%
  group_by(firstContestant, first) %>%
  tally() %>%
  arrange(firstContestant, -n)
```

### Generate Fig. 2

```{r}
fig2.d <- d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(observation = round(abs(.5 - first_observation), 2),
         response = ifelse(firstContestant == 'short', 100-response, response),
         first = ifelse(firstContestant == 'short', 4-first, first)) %>%
  mutate(first = ifelse(first < 4, 'less strong', 'strongest'),
         first = paste0('expected ', first, ' evidence first'))

fig2.boot <- fig2.d %>%
  group_by(observation, first) %>%
  tidyboot::tidyboot_mean(response) %>%
  ungroup()

fig2.d %>%
  ggplot(aes(x = observation, y = response)) + #color = firstContestant
    geom_point(aes(x = observation, y = empirical_stat), size = 2, data = fig2.boot) +
    geom_line(aes(x = observation, y = empirical_stat), data = fig2.boot) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, y =empirical_stat), 
                  width = 0, data = fig2.boot) +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    ggthemes::theme_few() +
    labs(x = 'strength', y = 'belief about mean') +
    facet_wrap(~ first) +
    guides(color=FALSE) +
    theme(aspect.ratio = 1) +
    ylim(0,100)

ggsave('speaker_dependence.pdf', units = 'in', height = 4, width = 6)
```


### Statistics

```{r}
m1 <- d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(observation = round(abs(.5 - first_observation), 2) - .25,
         response = ifelse(firstContestant == 'short', 100-response, response),
         first = ifelse(firstContestant == 'short', 4-first, first),
         first = ifelse(first < 4, 'less strong', 'strongest'),
         first = paste0('expected ', first, ' evidence first')) %>%
  select(response, observation, first, firstContestant) %>%
  lm(response ~ observation * first + firstContestant, 
     contrasts = list(first = contr.sum(2), firstContestant = contr.sum(2)), 
     data = .) 

summary(m1)
```

post-hoc t-test just for weak evidence values

```{r}
d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(observation = round(abs(.5 - first_observation), 2) - .25,
         response = ifelse(firstContestant == 'short', 100-response, response),
         first = ifelse(firstContestant == 'short', 4-first, first),
         first = ifelse(first < 4, 'less strong', 'strongest'),
         first = paste0('expected ', first, ' evidence first')) %>%
  filter(observation == -0.15) %>%
  select(gameid, response, first) %>%
  lm(response ~ first, data = .) %>%
  summary()
```

# Section 2: Model-based analyses

## Derive MAP beliefs & CIs from predictives file

```{r}
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

HPDhi<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

HPDlo<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

d_het_n24 <- read_csv(here("../models/model-comparison/data/rsa-het-data_no0.2_0.4.csv"))

# predictive <- read_csv(here("analysis/rsa-pp-params-posterior.csv"))
predictive_rsa <- read_csv("../stickgame/webppl-src/model-comparison/results/rsa-pp-params-posterior.csv")
# predictive_mas <- read_csv("../stickgame/webppl-src/model-comparison/results/cluster/results/run14/mas-pp-params-posterior.csv")
predictive_mas <- read_csv("../stickgame/webppl-src/model-comparison/results/mas-pp-params-posterior_new.csv")
```

Make individual histogram for each participant

```{r}
predictive_mas %>% 
  gather(gameid, value, -prob, -X1) %>%
  ggplot(aes(x = value)) +
    geom_histogram() +
    facet_wrap(~ gameid)

ggsave('predictiveHistograms.pdf', height = 20, width = 20, units = 'in')
```

Make scatter plot of MAP estimate and empirical belief for each individual

```{r}
predictive %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  ggplot(aes(x = MAPmodel, y = belief)) +
    geom_point() +
    geom_abline(intercept = 0, slope = 1) +
    facet_grid(agent1stick ~ firstStick) +
    xlim(0,1) +
    ylim(0,1)

```

```{r}
d_notbystick <- d_het_n24 %>%
  group_by(agent1stick) %>%
  tidyboot::tidyboot_mean(belief)

ggplot() +
  geom_point(data=d_notbystick, aes(x=agent1stick, y=empirical_stat)) +
  geom_errorbar(data=d_notbystick, aes(x=agent1stick, ymin=ci_lower, ymax=ci_upper), width=0) +
  geom_hline(yintercept=0.5, linetype='dotted') + 
  # facet_grid( ~ firstStick) +
  ggthemes::theme_few() + 
  labs(x = 'agent 1 stick length', y = 'belief about mean') +
  xlim(0.6, 0.9) + 
  ylim(0, 1)
```

summarize means for each condition

```{r}
d_rsa_pp <- predictive_rsa %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(MAPmodel) %>%
  mutate(group = 'rsa')

d_mas_pp <- predictive_mas %>%
  gather(gameid, value, -prob, -X1) %>%
  group_by(gameid) %>%
  summarize(MAPmodel = estimate_mode(value),
            upper_ci_model = HPDhi(value),
            lower_ci_model = HPDlo(value)) %>%
  left_join(d_het_n24) %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(MAPmodel) %>%
  mutate(group = 'mas')

d_bystick <- d_het_n24 %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = firstStick * 10) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(belief) %>%
  mutate(group = 'actual')

# ggplot() +
#   geom_point(data=d_bystick, aes(x=agent1stick, y=empirical_stat)) +
#   geom_errorbar(data=d_bystick, aes(x=agent1stick, ymin=ci_lower, ymax=ci_upper), width=0) +
#   geom_hline(yintercept=0.5, linetype='dotted') + 
#   facet_grid( ~ firstStick) +
#   ggthemes::theme_few() + 
#   labs(x = 'agent 1 stick length', y = 'belief about mean') +
#   xlim(0.6, 0.9) + 
#   ylim(0, 1)

d_ppcomp <- d_bystick %>%
  full_join(d_rsa_pp) %>%
  full_join(d_mas_pp)
```

# Supplemental: examine survey responses

```{r}
wee_criterion <- d %>%
  filter((gameid %in% complete_games)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, button_pressed, gameid) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, button_pressed) %>%
  filter(first %in% c(4)) %>%
  pull(gameid) %>%
  unique()

survey_reponses <- d %>%
  filter(gameid %in% wee_criterion) %>%
  filter(stimulus_type %in% c('speakerSurvey', 'judgeSurvey', 'exit_survey')) %>%
  filter(responses != '{"Q0":""}') %>%
  filter(!grepl("no", responses, ignore.case = TRUE)) %>%
  filter(!grepl("n/a", responses, ignore.case = TRUE)) %>%
  filter(!grepl("Sam", responses)) %>%
  # mutate(answer = substr(responses, 7, 100)) %>%
  select(gameid, stimulus_type, responses) %>%
  arrange(gameid)
```

# Supplemental: examine trial-level response time distribution

```{r}
d %>%
  filter(stimulus_type== 'isLong') %>%
  group_by(gameid, stimulus_type) %>%
  summarize(rt = mean(rt)) %>%
  ggplot(aes(x = rt)) +
    geom_histogram() +
    theme_bw() +
    geom_vline(xintercept = 5000) +
    xlim(4000, 50000)
```

# Appendix A: Attention checks

## Generate Table S1

```{r}
stricter_checks <- internally_consistent %>%
  filter(passedBias) %>%
  mutate(genModel = (10*first_observation + 10*second_observation + `genModel_third` + `genModel_fourth` + `genModel_fifth`)/5,
         `2afcConsistent` = (`2afc` == 1 & meanSlider >= 45) | (`2afc` == 0 & meanSlider <= 55) ,
         `genModelConsistent` = ( (`2afc` == 1 & meanSlider >= 45 & genModel >= 4.5) 
                                | (`2afc` == 0 & meanSlider <= 55 & genModel <= 5.5))) %>%
  mutate(speakerTrial_first = ifelse(firstContestant == 'short', 4 - speakerTrial_first, speakerTrial_first)) 
passedStrict <- stricter_checks %>% filter(genModelConsistent) %>% pull(gameid) %>% unique()

stricter_checks %>%
  group_by(group = ifelse(speakerTrial_first < 4, 'not strongest first', 'strongest')) %>%
  summarize(`n` = length(passedBias),
            `% 2afc` = mean(`2afcConsistent`, na.rm = T),
            `% genModel` = mean(genModelConsistent, na.rm = T),
            `% all checks` = mean(allPassed, na.rm = T)) %>%
  xtable()
```

binomial proportion? 

```{r}
internally_consistent %>%
  filter(passedBias) %>%
  mutate(genModel = (10*first_observation + 10*second_observation + `genModel_third` + `genModel_fourth` + `genModel_fifth`)/5,
         `2afcConsistent` = (`2afc` == 1 & meanSlider >= 45) | (`2afc` == 0 & meanSlider <= 55) ,
         `genModelConsistent` = ( (`2afc` == 1 & meanSlider >= 45 & genModel >= 4.5) 
                                | (`2afc` == 0 & meanSlider <= 55 & genModel <= 5.5) ),
         allPassed = `2afcConsistent` & genModelConsistent) %>%
  mutate(speakerTrial_first = ifelse(firstContestant == 'short', 4 - speakerTrial_first, speakerTrial_first)) %>%
  group_by(`2afcConsistent`, genModelConsistent, group = ifelse(speakerTrial_first < 4, 'not strongest first', 'strongest')) %>%
  tally()

prop.test(c(33, 53), c(238, 485))
```

### Full sequence of sticks (report mode)

```{r}
d %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(firstContestant, stimulus_contestant, gameid, chosenStick) %>%
  mutate(chosenStick = as.numeric(gsub('in', '', chosenStick)),
         firstContestant = ifelse(firstContestant == 'long', 'long-biased first', 'short-biased first'),
         stimulus_contestant = case_when(stimulus_contestant == 'first' ~ 1, stimulus_contestant == 'second' ~ 2,
                                         stimulus_contestant == 'third' ~ 3, stimulus_contestant == 'fourth' ~ 4, TRUE ~ 5)) %>%
  group_by(gameid) %>%
  mutate(origStick = first(chosenStick)) %>%
  ggplot(aes(x = stimulus_contestant, y = chosenStick, group = gameid, color = factor(origStick))) +
    geom_line(alpha = 0.01, size = 5) +
    facet_grid(firstContestant ~ .) +
    theme_few() +
    theme(legend.position = 'none') +
    labs(x = 'order of presentation', y = 'expected stick')
```

# Appendix B: Examine second stick

```{r}
beliefChange.d <- d %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  select(stimulus_contestant, agent1stick, agent2stick, gameid, response) %>%
  spread(stimulus_contestant, response) %>%
  mutate(diff = second - first)
```

```{r}
beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  group_by(agent1stick, agent2stick, speaker_pref) %>%
  mutate(speaker_pref = factor(ifelse(speaker_pref <= 2, '<=7', paste0(speaker_pref + 5)))) %>%
  summarize(m_first = mean(first), m_second = mean(second)) %>%
  gather(order, belief, m_first, m_second) %>%
  mutate(stick = ifelse(order == 'm_first', agent1stick, agent2stick)) %>%
  ggplot(aes(x = order, y = belief, color = stick, fill = stick, group = interaction(agent1stick, agent2stick))) +
    geom_line(arrow = arrow(angle = 20, length = unit(0.1, "inches"), type = "closed"), alpha = 1) +
    geom_point() +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    geom_vline(xintercept = 50, linetype = 'dotted') +
    facet_grid(fct_rev(speaker_pref) ~ agent1stick) +
    ggthemes::theme_few() +
    scale_color_gradient2(midpoint = 0.5, limits=c(0,1)) +
    scale_fill_gradient2(midpoint = 0.5, limits=c(0,1)) +
    labs(x = 'first  belief', y = 'second belief') +
    theme(aspect.ratio = 1)

ggsave('second_stick.pdf', units = 'in', height = 6, width = 8)
```

```{r}
ref.points <- data.frame(agent1stick = c(rep(seq(.5, .9, .1), 3), rep(.5, 15)),
                         agent2stick = c(rep(.5, 15), rep(seq(.1, .5, .1), 3)),
                         speaker_pref = rep(c(rep(2, 5), rep(3, 5), rep(4, 5)), 2),
                         empirical_stat = 50)

beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  mutate(speaker_pref = ifelse(speaker_pref < 2, 2, speaker_pref)) %>%
  group_by(agent1stick,  agent2stick, speaker_pref) %>%
  #filter(speaker_pref == 4) %>%
  tidyboot::tidyboot_mean(second) %>%
  bind_rows(ref.points) %>%
  ggplot(aes(x = fct_rev(factor(agent2stick)), y = factor(agent1stick), fill = empirical_stat)) +
    geom_tile() +
    geom_abline(intercept = 0, slope = 1) +
    facet_grid( ~ speaker_pref) +
    ggthemes::theme_few() +
    theme(aspect.ratio = 1) +
    scale_fill_gradient2(midpoint = 50) +
    labs(x = 'first stick length', y = 'second stick length')

ggsave('order_effect.pdf', units = 'in', height = 4, width = 8)
```

Absolute change in belief (anything above 0, i.e. adjusting belief in direction of 'long' after seeing evidence consistent with 'short', is weak evidence effect) by speaker (broken)

```{r}
beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  group_by(agent1stick, agent2stick, speaker_pref) %>%
  mutate(speaker_pref = ifelse(speaker_pref < 2, 2, speaker_pref)) %>%
  tidyboot::tidyboot_mean(diff) %>%
  ggplot(aes(x = agent2stick, y = empirical_stat, color = agent1stick, group = agent1stick)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_smooth(method = 'lm',fullrange = TRUE, se = F) +
    ylim(-100, 50) + 
    xlim(0, 0.5) + 
    geom_hline(yintercept = 0, linetype = 'dotted') +
    facet_grid( ~ speaker_pref) +
    ggthemes::theme_few() +
    labs(x = 'agent 2 stick length', y = 'absolute change in belief')
```

# Appendix Fig. S3

```{r}
fig2.d %>%
  ggplot(aes(x = observation, y = response)) + #color = firstContestant
    geom_boxplot(aes(x = factor(observation)), outlier.shape = NA) +
    #geom_point(aes(x = observation, y = empirical_stat), size = 2, data = fig2.boot) +
    # geom_line(aes(x = observation, y = empirical_stat), data = fig2.boot) +
    # geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, y =empirical_stat), width = 0, data = fig2.boot) +
    geom_jitter(aes(x=factor(observation)), alpha = 0.075, height = 0, width = 0.2) +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    #geom_abline(intercept = 0, slope = 100, linetype = 'dotted') +
    ggthemes::theme_few() +
    labs(x = 'observation strength (distance from 0.5)', y = 'belief about mean') +
    facet_wrap(~ first) +
    #scale_color_manual(values=c('#2E3192', '#EC008C')) +
    #scale_x_continuous(breaks=c(.1,.2,.3,.4,.5,.6,.7,.8,.9), labels=c(1,2,3,4,5,6,7,8,9))+
    guides(color=FALSE) +
    theme(aspect.ratio = 1) +
    ylim(0,100)

ggsave('speaker_dependence_rawdata.pdf', units = 'in', height = 4, width = 6)
```
