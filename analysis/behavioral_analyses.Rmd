---
title: "R Notebook"
output: html_notebook
---

# Import data & packages

```{r}
library(tidyverse)
library(tidyboot)
library(lme4)
library(lmerTest)
library(broom.mixed) 
d <- read_csv('../stickgame/human-experiments/dataFromMongo.csv') 
```

# Implement exclusions, get descriptive stats

```{r}
complete_games <- d %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid)

cat(length(complete_games), 'participants completed both isLong trials')

passed_manip_check <- d %>%
  filter(stimulus_type == 'bias') %>%
  select(stimulus_contestant, response, gameid, agent1stick) %>%
  spread(stimulus_contestant, response) %>%
  filter(first > 60, second < 40) %>%
  pull(gameid)

cat(length(passed_manip_check), 'participants passed bias manipulation check')

passed_rt_criterion <- d %>%
  filter(stimulus_type == 'isLong') %>%
  mutate(log_rt = log(rt),
         lower = mean(log_rt) - 2*sd(log_rt),
         upper = mean(log_rt) + 2*sd(log_rt)) %>%
  filter(log_rt > lower, log_rt < upper) %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid)

cat(length(passed_rt_criterion), 'participants passed RT exclusion')
cat(length(intersect(passed_rt_criterion, passed_manip_check)), 'participants passed both criteria')
```

# Plot change in belief

```{r}
beliefChange.d <- d %>%
  filter(gameid %in% complete_games) %>%
  filter(gameid %in% intersect(passed_manip_check, passed_rt_criterion)) %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  select(stimulus_contestant, agent1stick, gameid, response) %>%
  spread(stimulus_contestant, response) %>%
  mutate(diff = second - first) 

beliefChange.d %>%
  group_by(agent1stick) %>%
  tidyboot::tidyboot_mean(diff) %>%
  ggplot(aes(x = agent1stick, y = empirical_stat)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_smooth(method = 'lm', color = 'red') +
    geom_hline(yintercept = 0, linetype = 'dotted') +
    ggthemes::theme_few() +
    labs(x = 'agent 2 stick length', y = 'absolute change in belief')
    
```

# Look at statistics

```{r}
# This seems like the most obvious way to run the regression...?
beliefChange.d %>%
  mutate(agent1stick = agent1stick - 0.5) %>%
  lm(diff ~ agent1stick, data = .) %>%
  tidy()

# a slightly weirder alternative...
# d %>%
#   filter(gameid %in% complete_games) %>%
#   filter(gameid %in% intersect(passed_manip_check, passed_rt_criterion)) %>%
#   filter(stimulus_type == 'isLong') %>%
#   mutate(agent1stick = agent1stick - 0.5) %>%
#   lmer(response ~ agent1stick + stimulus_contestant + (1 | gameid), data = .) %>%
#   tidy()
```

# Supplemental: examine trial-level response time distribution

```{r}
d %>%
  filter(stimulus_type== 'isLong') %>%
  group_by(gameid, stimulus_type) %>%
  summarize(rt = mean(rt)) %>%
  ggplot(aes(x = log(rt))) +
    geom_histogram(bins = 15) +
    theme_bw()
```

