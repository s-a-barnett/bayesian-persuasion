---
title: "R Notebook"
output: html_notebook
---

# Import data & packages

```{r}
library(tidyverse)
library(tidyboot)
library(lme4)
library(lmerTest)
library(broom.mixed)
d_1 <- read_csv('../stickgame/human-experiments/dataFromMongo_prolificPilot1.csv')
d_2 <- read_csv('../stickgame/human-experiments/dataFromMongo_prolificPilot2.csv')
d_3 <- read_csv('../stickgame/human-experiments/dataFromMongo_prolificSample1.csv')
d_4 <- read_csv('../stickgame/human-experiments/dataFromMongo_prolificSample2.csv')
d_raw <- rbind(d_1, d_2, d_3, d_4) %>%   
  rename(agent1stick = agent2stick, agent2stick = agent1stick)

```

# Implement exclusions, get descriptive stats

```{r}
complete_games <- d_raw %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid)

cat(length(complete_games), 'participants completed both isLong trials \n')

passed_manip_check <- d_raw %>%
  filter(gameid %in% complete_games) %>%
  filter(stimulus_type == 'bias') %>%
  select(stimulus_contestant, response, gameid, agent1stick) %>%
  spread(stimulus_contestant, response) %>%
  filter(first > 60 & second < 40) %>%
  pull(gameid) %>%
  unique()

cat(length(passed_manip_check), 'participants passed bias manipulation check \n')

passed_rt_criterion <- d_raw %>%
  filter(stimulus_type == 'isLong') %>%
  # mutate(log_rt = log(rt),
  #        lower = mean(log_rt) - 2*sd(log_rt),
  #        upper = mean(log_rt) + 2*sd(log_rt)) %>%
  filter(rt > 8000, rt < 40000) %>%
  group_by(gameid) %>%
  tally() %>%
  filter(n == 2) %>%
  pull(gameid) %>%
  unique()

cat(length(passed_rt_criterion), 'participants passed RT exclusion \n')

speaker_criterion <- d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, button_pressed, gameid) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, button_pressed) 

passed_speaker_criterion <- speaker_criterion %>%
  filter(first %in% c(2,3,4) & second %in% c(0,1)) %>% 
  pull(gameid) %>%
  unique()

cat(length(passed_speaker_criterion), 'participants passed speaker exclusion \n')

ok_games  <- intersect(passed_rt_criterion, intersect(passed_speaker_criterion, passed_manip_check) )
cat(length(ok_games), 'participants passed all criteria \n')

d <- d_raw %>%
  filter(gameid %in% ok_games)
```

## Inspect frequency of different sequences on speaker trials

```{r}
d_raw %>%
  filter((gameid %in% complete_games)) %>%
  filter((gameid %in% passed_manip_check)) %>%
  filter(stimulus_type == 'speakerTrial') %>%
  select(stimulus_contestant, gameid, chosenStick) %>%
  group_by(gameid) %>%
  spread(stimulus_contestant, chosenStick) %>%
  unite(sequence, first, second, third, fourth) %>%
  group_by(sequence) %>%
  tally() %>%
  arrange(-n)
```

```{r}
d %>%
  filter(stimulus_type == 'isLong') %>%
  filter(stimulus_contestant == 'first') %>%
  left_join(speaker_criterion) %>%
  mutate(first = paste0('showed stick', first, 'first')) %>%
  group_by(agent1stick, first) %>%
  tidyboot::tidyboot_mean(response) %>%
  ggplot(aes(x = agent1stick, y = empirical_stat)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    ggthemes::theme_few() +
    labs(x = 'agent 1 stick length', y = 'belief about mean') +
    facet_wrap(~ first) +
    guides(color=FALSE) +
    xlim(0.5,1)+
    ylim(0,100)
```
# Plot change in belief

```{r}
beliefChange.d <- d %>%
  filter(stimulus_type == 'isLong') %>%
  group_by(gameid) %>%
  select(stimulus_contestant, agent1stick, agent2stick, gameid, response) %>%
  spread(stimulus_contestant, response) %>%
  mutate(diff = second - first)
```

Actual belief reported at this point in experiment 

```{r}
beliefChange.d %>%
  group_by(agent1stick, agent2stick) %>%
  tidyboot::tidyboot_mean(second) %>%
  ggplot(aes(x = agent2stick, y = empirical_stat)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_smooth(method = 'lm', color = 'red') +
    geom_hline(yintercept = 50, linetype = 'dotted') +
    facet_wrap(~ agent1stick) +
    ggthemes::theme_few() +
    labs(x = 'agent 2 stick length', y = 'absolute belief')
```

Absolute change in belief (anything above 0, i.e. adjusting belief in direction of 'long' after seeing evidence consistent with 'short', is weak evidence effect)

```{r}
beliefChange.d %>%
  left_join(speaker_criterion %>% select(gameid, first) %>% rename(speaker_pref = first)) %>%
  group_by(agent1stick, agent2stick, first) %>%
  tidyboot::tidyboot_mean(diff) %>%
  ggplot(aes(x = agent2stick, y = empirical_stat, color = agent1stick)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_smooth(method = 'lm', color = 'red') +
    geom_hline(yintercept = 0, linetype = 'dotted') +
    facet_wrap(~ first) +
    ggthemes::theme_few() +
    labs(x = 'agent 2 stick length', y = 'absolute change in belief')
```

# Look at statistics

```{r}
# This seems like the most obvious way to run the regression...?
beliefChange.d %>%
  mutate(agent1stick = agent1stick - 0.5) %>%
  lm(diff ~ agent1stick, data = .) %>%
  tidy()

# a slightly weirder alternative...
# d %>%
#   filter(gameid %in% complete_games) %>%
#   filter(gameid %in% intersect(passed_manip_check, passed_rt_criterion)) %>%
#   filter(stimulus_type == 'isLong') %>%
#   mutate(agent1stick = agent1stick - 0.5) %>%
#   lmer(response ~ agent1stick + stimulus_contestant + (1 | gameid), data = .) %>%
#   tidy()
```

# Supplemental: examine trial-level response time distribution

```{r}
d %>%
  filter(stimulus_type== 'isLong') %>%
  group_by(gameid, stimulus_type) %>%
  summarize(rt = mean(rt)) %>%
  ggplot(aes(x = rt)) +
    geom_histogram() +
    theme_bw() +
    geom_vline(xintercept = 5000) +
    xlim(4000, 50000)
```

#Supplemental: plot generative model histograms

```{r}
d %>%
  filter(gameid %in% complete_games) %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type == 'genModel') %>%
  filter(agent2stick == 0.6) %>%
  mutate(genStick = button_pressed + 1) %>%
  ggplot(aes(genStick)) + 
    geom_histogram() + 
    scale_x_continuous(name="stick length", breaks=0:10, limits=c(0, 10))
```

#Supplemental: plot generative model histograms

```{r}
d %>%
  filter(gameid %in% complete_games) %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type == 'genModel') %>%
  filter(agent2stick == 0.6) %>%
  mutate(genStick = button_pressed + 1) %>%
  filter(genStick > 6)

d %>%
  filter(gameid == '8834-a8a77fcd-2ed5-41cc-acd1-52c71e21c4e3') %>%
  filter(stimulus_type == 'isLong')
```

# Supplemental: examine 2afc vs. point estimate

```{r}
d %>%
  filter(gameid %in% ok_games) %>%
  filter(stimulus_type %in% c('2afc', 'meanSlider')) %>%
  arrange(gameid)
  #filter(((button_pressed == 0) & (response < 50)) | ((button_pressed == 1) & (response >= 50)))
```
