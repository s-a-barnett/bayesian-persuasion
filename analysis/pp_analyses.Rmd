---
title: "R Notebook"
output: html_notebook
---

# Import data & packages

```{r}
library(tidyverse)
library(tidyboot)
library(broom.mixed)
library(coda)
library(here)
```

# Section 2: Model-based analyses

## Derive MAP beliefs & CIs from predictives file

```{r}
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

HPDhi<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

HPDlo<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

d_het_n24_original <- read_csv(here("models/model-comparison/input/original_data_full.csv"))
d_het_n24_replication <- read_csv(here("models/model-comparison/input/replication_data_full.csv")) %>%
  mutate(agent1stick = agent1stick * 10) %>%
  mutate(firstStick = ifelse(firstStick * 10 < 8, 8, firstStick * 10))


predictive_rsa_replication <- read_csv(here("models/model-comparison/output/rsa-pp-params-posterior_replication_100.csv"))
predictive_mas_adding_replication <- read_csv(here("models/model-comparison/output/mas-pp-het-simple-params-posterior_replication_100.csv"))
```


```{r}
d_rsa_pp <- predictive_rsa_replication %>%
  gather(gameid, value, -prob) %>%
  group_by(gameid) %>%
  summarize(value = mean(value)) %>%
  left_join(d_het_n24_replication) %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(value) %>%
  mutate(group = 'rsa')

d_mas_adding_pp <- predictive_mas_adding_replication %>%
  gather(gameid, value, -prob) %>%
  group_by(gameid) %>%
  summarize(value = mean(value)) %>%
  left_join(d_het_n24_replication) %>%
  group_by(agent1stick, firstStick) %>%
  # summarize(empirical_stat = estimate_mode(value),
  #           ci_upper = HPDhi(value),
  #           ci_lower = HPDlo(value)) %>%
  # summarize(empirical_stat = estimate_mode(value)) %>%
  tidyboot::tidyboot_mean(value) %>%
  mutate(group = 'mas')

d_bystick <- d_het_n24_replication %>%
  group_by(agent1stick, firstStick) %>%
  tidyboot::tidyboot_mean(belief, nboot = 100) %>%
  mutate(group = 'actual')
```

```{r}
pd <- position_dodge(0.4)

d_bystick %>%
  ggplot(aes(x=agent1stick, y=empirical_stat, colour=group, fill = group)) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), colour = NA, fill = 'black', alpha = .2) + 
    geom_hline(yintercept=0.5, linetype='dotted') + 
    geom_point(data = full_join(d_rsa_pp, d_mas_adding_pp)) +
    geom_line(data = full_join(d_rsa_pp, d_mas_adding_pp)) +
    #geom_point() + 
    scale_color_manual(values=c('red', 'blue')) +
    scale_size_manual(values=c(10, 1, 1)) +
    facet_grid( ~ firstStick) +
    ggthemes::theme_few() + 
    labs(x = 'judge stick', y = 'belief about mean') +
    xlim(5.5, 9.5) + 
    scale_y_continuous(breaks=seq(0, 1.1, 0.1), limits = c(0, 1))

ggsave("ppcheck_replication.pdf", width = 6, height = 3)
```

```{r}
left_join(predictive_rsa_replication %>% 
            gather(gameid, rsa_value, -prob) %>% 
            group_by(gameid) %>%
            summarize(rsa_value = mean(rsa_value)) ,
          predictive_mas_adding_replication %>% 
            gather(gameid, mas_value, -prob) %>%
            group_by(gameid) %>%
            summarize(mas_value = mean(mas_value))) %>%
  left_join(d_het_n24_replication) %>%
  gather(model, prediction, rsa_value, mas_value) %>%
  ggplot(aes(x = belief, y =prediction)) +
    geom_jitter(width = 0.01, height = 0.01, alpha = 0.25) +
    geom_abline(intercept = 0, slope = 1) +
    ylim(0, 1) +
    facet_grid(. ~ model) +
    ggthemes::theme_few() 

```