<!DOCTYPE html>
<html>
  <head>
    <title>Experiment 1</title>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>
    var preview = {
      type: 'instructions',
      pages: ['<p> Welcome! In this HIT, you will make a series of quick decisions based on evidence. </p>' +
              '<p> <b> If you are interested in learning more about this HIT, ' +
              'please first accept the HIT in MTurk before continuing further</b>. </p>'],
      show_clickable_nav: false,
      allow_keys: false
    }

    var welcome = {
      type: 'html-keyboard-response',
      stimulus:
        'Thank you for accepting the HIT. Press any key to begin.'
    }

    window.onload = function() {
      setupGame();
    }

    window.onbeforeunload = function() {
      return "Data will be lost if you leave the page, are you sure?";
    };

    function setupGame () {
      var socket = io.connect();
      var timeline = [];

      // Values fixed for human experiments.
      var iterationName = 'testing'
      var numSticks = 5
      var agentBias = 10
      var sliderWidthScale = 0.7

      // Start building timeline when we hear from server
      socket.on('onConnected', function(mongoData) {

        // get workerId, etc. from URL (so that it can be sent to the server)
        var turkInfo = jsPsych.turk.turkInfo();

        // Extract stick data from mongo
        var agent1stick = mongoData.agent1stick
        var agent2stick = mongoData.agent2stick

        // if still in preview mode, tell them to accept first, otherwise show first slide
        if (!turkInfo.previewMode) {
          timeline.push(welcome);
        } else {
          timeline.push(preview);
        }

        var instructions_1 = {
          type: "image-button-response",
          stimulus: "figures/twopeople.png",
          prompt:
            "<p> In this HIT, you will serve as the judge for a heated debate.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_1);

        var instructions_2 = {
          type: "image-button-response",
          stimulus: "figures/stickExampleBlack.png",
          prompt:
            "<p> The two contestants in this debate have been given a secret " +
            "set of sticks ranging in length from very long ones to very short" +
            " ones.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_2);

        var instructions_3 = {
          type: "image-button-response",
          stimulus: "figures/exampleRedHighlight.png",
          prompt:
            "<p> One contestant (shown in red) will be rewarded handsomely " +
            "if they can convince you that the average length of these sticks is " +
            "<strong> shorter than 5in (see dotted line)</strong>.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_3);

        var instructions_4 = {
          type: "image-button-response",
          stimulus: "figures/exampleBlueHighlight.png",
          prompt:
            "<p> The other (shown in blue) will get paid if " +
            "if they can convince you that the average length of these sticks is " +
            "<strong> longer than 5in (see dotted line)</strong>. " +
            "In this case, the average length is 6in, so this person was correct!</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_4);

        var instructions_5 = {
          type: "image-button-response",
          stimulus: "figures/exampleAllGrey.png",
          prompt:
            "<p>As the judge, however, you will not be able to see the full " +
            "set of sticks: you will only see what the contestants choose " +
            "to show you. They will each try to convince you by taking turns " +
            "revealing one of the five secret sticks.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_5);

        var instructions_6 = {
          type: "image-slider-response",
          stimulus: "figures/stick8.png",
          prompt:
            "<p>After you see each stick, you will use this slider to report " +
            "how strongly you are leaning in your decision. If you think the stick " +
            "average is more likely to be <strong>shorter than 5in</strong>, " +
            "click further to the left. If you think it is more likely to be " +
            "<strong>longer than 5in</strong>, click further to the right.</p>" +
            "<p>Please move the slider before pressing 'Continue'.</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(instructions_6);

        var instructions_7 = {
          type: "image-slider-response",
          stimulus: "figures/stick8grey.png",
          prompt:
            "<p>Of course, people differ in their response to incentives and " +
            "how much they are willing to bend the truth.</p>" +
            "<p>Therefore, after each turn, you will use this slider to report " +
            "how biased each contestant is. If you think the contestant " +
            "is more likely to show <strong>shorter sticks</strong>, " +
            "click further to the left. If you think they are more likely to show " +
            "<strong>longer sticks</strong>, click further to the right.</p>" +
            "<p>Please move the slider before pressing 'Continue'.</p>",
          labels: ['Biased towards showing shorter sticks',
                    'Showing sticks at random',
                    'Biased towards showing longer sticks'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(instructions_7);

        var ready_screen = {
          type: "html-button-response",
          stimulus: "<p>Ready to begin? Click 'Continue'!</p>",
          choices: ['Continue']
        }

        timeline.push(ready_screen)

        // Make the choices feel more realistic by adding arbitrary delay.
        var pre_first_move = {
          type: "html-keyboard-response",
          stimulus: "<p> Blue contestant choosing move... </p>",
          choices: jsPsych.NO_KEYS,
          trial_duration: jsPsych.randomization.sampleWithReplacement([3000, 4000, 5000], 1)[0]
        }

        timeline.push(pre_first_move);

        var first_move = {
          type: "image-slider-response",
          stimulus: "figures/stick" + (10 * agent2stick) + ".png",
          prompt:
            "<p>Blue contestant shows a stick of length " + (10 * agent2stick) +
            "in from the sample.</p>" +
            "<p>Is the average stick length for the whole sample more likely to " +
            "be longer or shorter than 5in?</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(first_move);

        // Allows us to measure the strong evidence effect for listeners.
        var post_first_move = {
          type: "image-slider-response",
          stimulus: "figures/stick" + (10 * agent2stick) + "grey.png",
          prompt:
            "<p>How biased is the blue contestant?</p>",
          labels: ['Biased towards showing shorter sticks',
                    'Showing sticks at random',
                    'Biased towards showing longer sticks'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(post_first_move);

        // Make the choices feel more realistic by adding arbitrary delay.
        var pre_second_move = {
          type: "html-keyboard-response",
          stimulus: "<p> Red contestant choosing move... </p>",
          choices: jsPsych.NO_KEYS,
          trial_duration: jsPsych.randomization.sampleWithReplacement([3000, 4000, 5000], 1)[0]
        }

        timeline.push(pre_second_move);

        var second_move = {
          type: "image-slider-response",
          stimulus: "figures/sticks" + (10 * agent1stick) + "and" + (10 * agent2stick) + ".png",
          prompt:
            "<p>Blue contestant shows a stick of length " + (10 * agent2stick) +
            "in from the sample, and the red contestant shows a stick of length " +
            (10 * agent1stick) + "in from the sample.</p>" +
            "<p>Is the average stick length for the whole sample more likely to " +
            "be longer or shorter than 5in?</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(second_move);

        // Allows us to measure the strong evidence effect for listeners.
        var post_second_move = {
          type: "image-slider-response",
          stimulus: "figures/sticks" + (10 * agent1stick) + "and" + (10 * agent2stick) + "grey.png",
          prompt:
            "<p>How biased is the red contestant?</p>",
          labels: ['Biased towards showing shorter sticks',
                    'Showing sticks at random',
                    'Biased towards showing longer sticks'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };

        timeline.push(post_second_move);

        var goodbye = {
          type: 'html-keyboard-response',
          stimulus: 'Thank you for participating! Press any key to exit.'
        }

        timeline.push(goodbye);

        // Store experiment parameter settings in the data.
        jsPsych.data.addProperties({
          numSticks: numSticks,
          agentBias: agentBias,
          agent1stick: agent1stick,
          agent2stick: agent2stick
        });

        jsPsych.init({
          timeline: timeline,
          on_finish : function() {
            // At the end of the experiment, submit to turk
            console.log('sending data to mturk');
            jsPsych.turk.submitToTurk();
          },
          on_trial_finish: function(trialData) {
            // At the end of each trial, send data to server
            var packet = Object.assign({}, mongoData, trialData, {
              dbname: 'bayesian-persuasion',
              colname: 'experiment1',
              wID: turkInfo.workerId,
              aID: turkInfo.assignmentId,
              hitID: turkInfo.hitId,
              iterationName: iterationName
            })
            socket.emit('currentData', packet);
          }
        });

      });
    }
    </script>
</html>
