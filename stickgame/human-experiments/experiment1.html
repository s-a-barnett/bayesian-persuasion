<!DOCTYPE html>
<html>
  <head>
    <title>Experiment 1</title>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    var preview = {
      type: 'instructions',
      pages: ['<p> Welcome! In this HIT, you will make a series of quick decisions based on evidence. </p>' +
              '<p> <b> If you are interested in learning more about this HIT, ' +
              'please first accept the HIT in MTurk before continuing further</b>. </p>'],
      show_clickable_nav: false,
      allow_keys: false
    }

    var welcome = {
      type: 'html-keyboard-response',
      stimulus:
        'Thank you for accepting the HIT. Press any key to begin.'
    }

    var consent = {
      type: 'html-button-response',
      stimulus:
        "<font size='2'><p align='left'>This research is being conducted by Samuel Barnett, a graduate student, " +
        "Robert Hawkins and Mark Ho, postdoctoral " +
        "research fellows, and Tom Griffiths, a faculty member, at Princeton " +
        "University. This study takes approximately 5-10 minutes to complete.</p>" +
        "<p align='left'>If you agree to take part in the research, you will make a series " +
        "of judgments about a debate: at each stage you will be " +
        "presented with information displayed both as text and as an image and " +
        "will be asked to move a slider to express your judgment. " +
        "All of the information we obtain during the research will be kept " +
        "confidential, and not associated with your name in any way. However, " +
        "while the study is running it will be associated with your MTurk " +
        "worker id. Once the study is complete we will replace your worker id " +
        "with a random string.</p>" +
        "<p align='left'>If you have any questions about this research, do not hesitate to " +
        "contact Robert Hawkins at hawkrobe@gmail.com. If you have any questions " +
        "about your rights or treatment as a participant in this research project, " +
        "please contact the Princeton Office for Research Integrity and Assurance " +
        "by phone at 609-258-0865 or by email at ria@princeton.edu.</p>" +
        "<p align='left'>By consenting to participate, you acknowledge that you are 18 years " +
        "or older, have read this consent form, agree to its contents, and agree " +
        "to take part in this research. If you do not wish to consent, close " +
        "this page and return the HIT on Mechanical Turk.</p></font>",
      choices: ['I consent to participate.']
    }

    window.onload = function() {
      setupGame();
    }

    window.onbeforeunload = function() {
      return "Data will be lost if you leave the page, are you sure?";
    };

    function setupGame () {
      var socket = io.connect();
      var timeline = [];

      // Values fixed for human experiments.
      var iterationName = 'pilot2'
      var numSticks = 5
      var agentBias = 10
      var sliderWidthScale = 0.7
      var maxQuizAttempts = 3

      // Start building timeline when we hear from server
      socket.on('onConnected', function(mongoData) {

        // get workerId, etc. from URL (so that it can be sent to the server)
        var turkInfo = jsPsych.turk.turkInfo();

        // Extract stick data from mongo
        var agent1stick = mongoData.agent1stick
        var agent2stick = mongoData.agent2stick

        // if still in preview mode, tell them to accept first, otherwise show first slide
        if (!turkInfo.previewMode) {
          timeline.push(welcome);
          timeline.push(consent);
        } else {
          timeline.push(preview);
        }

        var instructions_1 = {
          type: "image-button-response",
          stimulus: "figures/twopeople.png",
          prompt:
            "<p> In this HIT, you will serve as the judge for a heated debate " +
            "between these two contestants.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_1);

        var instructions_2 = {
          type: "image-button-response",
          stimulus: "figures/stickExampleBlack.png",
          prompt:
            "<p> The two contestants in this debate have been given a secret " +
            "set of sticks ranging in length from very long ones to very short" +
            " ones.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_2);

        var instructions_3 = {
          type: "image-button-response",
          stimulus: "figures/exampleRedHighlight.png",
          prompt:
            "<p> One contestant (shown in red) will be rewarded handsomely " +
            "if they can convince you that the average length of these sticks is " +
            "<strong> shorter than 5in (see dotted line)</strong>.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_3);

        var instructions_4 = {
          type: "image-button-response",
          stimulus: "figures/exampleBlueHighlight.png",
          prompt:
            "<p> The other (shown in blue) will get paid if " +
            "if they can convince you that the average length of these sticks is " +
            "<strong> longer than 5in (see dotted line)</strong>. " +
            "In this case, the average length is 6in, so this person was correct!</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_4);

        var instructions_5 = {
          type: "image-button-response",
          stimulus: "figures/exampleAllGrey.png",
          prompt:
            "<p>As the judge, however, you will not be able to see the full " +
            "set of sticks: you will only see what the contestants choose " +
            "to show you. They will each try to convince you by taking " +
            "<strong>only one turn each</strong> " +
            "to reveal one of the five secret sticks.</p>",
          choices: ['Continue']
        };

        timeline.push(instructions_5);

        var instructions_6 = {
          type: "image-slider-response",
          stimulus: "figures/stick8.png",
          prompt:
            "<p>After you see each stick, you will use this slider to report " +
            "how strongly you are leaning in your decision. If you think the stick " +
            "average is more likely to be <strong>shorter than 5in</strong>, " +
            "click further to the left. If you think it is more likely to be " +
            "<strong>longer than 5in</strong>, click further to the right.</p>" +
            "<p>Please move the slider before pressing 'Continue'. " +
            "This is a practice judgment.</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true,
          data: {
            stimulus_type: 'practice'
          }
        };

        timeline.push(instructions_6);

        var quizAttempts = 1; // Initialize number of attempts at quiz

        var preQuiz = {
          type: "html-button-response",
          stimulus: "<p>Before we begin, you must complete a short quiz to " +
          "show that you understand the task. You must pass the quiz within " +
          maxQuizAttempts + " attempts to continue.</p>",
          choices: ['Continue']
        }

        timeline.push(preQuiz);


        var quizTrial = {
            type: 'survey-multi-choice',
            questions:
              [{prompt: "Who gets to see all five sticks?",
            		options: ["You", "The contestants", "You and the contestants", "Nobody"],
            		required:true},
               {prompt: "How are the sticks revealed to you?",
            		options: ["A contestant chooses a stick to show you", "At random", "You choose a stick to be revealed"],
            	  required: true},
               {prompt: "How many contestants are there?",
          		  options: ["0", "1", "2"],
          		  required: true},
               {prompt: "Fill in the blank: You are judging whether the ____ of the five sticks is longer than 5in.",
                options: ["Tallest", "Shortest", "Average"],
                required: true},
               {prompt: "Contestants will be rewarded based on your judgment.",
                options: ["True", "False"],
                required: true}
              ]
        };

        var loopNode = {
            timeline: [quizTrial],
            loop_function: function(data){
              	resp = JSON.parse(data.values()[0]['responses']);
              	if ((resp["Q0"] == 'The contestants') &&
                   (resp["Q1"]== 'A contestant chooses a stick to show you') &&
                   (resp["Q2"] == '2') && (resp["Q3"] == 'Average') &&
                   (resp["Q4"] == 'True')){
              	    return false;
              	} else {
              	    alert('Please try again! One or more of your responses was incorrect.');
                    quizAttempts += 1;
                    }
                    return true;
              	},
            on_finish: function() {
              if (quizAttempts >= maxQuizAttempts) {
                alert('Experiment terminated: too many failed quiz attempts.')
                jsPsych.endExperiment()
              }
            }
        }

        timeline.push(loopNode);

        var ready_screen = {
          type: "html-button-response",
          stimulus: "<p>Ready to begin? Click 'Continue'!</p>",
          choices: ['Continue']
        }

        timeline.push(ready_screen);

        // Make the choices feel more realistic by adding arbitrary delay.
        var pre_first_move = {
          type: "html-keyboard-response",
          stimulus: "<p> Blue contestant choosing move... </p>",
          choices: jsPsych.NO_KEYS,
          trial_duration: jsPsych.randomization.sampleWithReplacement([3000, 4000, 5000], 1)[0]
        }

        timeline.push(pre_first_move);

        var first_move = {
          type: "image-slider-response",
          stimulus: "figures/stick" + (10 * agent2stick) + ".png",
          prompt:
            "<p>The blue contestant shows a stick of length " + (10 * agent2stick) +
            "in from the set.</p>" +
            "<p>Is the average stick length for all five sticks more likely to " +
            "be longer or shorter than 5in?</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true,
          data: {
            stimulus_type: 'isLong',
            stimulus_contestant: 'first'
          }
        };

        timeline.push(first_move);

        // Make the choices feel more realistic by adding arbitrary delay.
        var pre_second_move = {
          type: "html-keyboard-response",
          stimulus: "<p> Red contestant choosing move... </p>",
          choices: jsPsych.NO_KEYS,
          trial_duration: jsPsych.randomization.sampleWithReplacement([3000, 4000, 5000], 1)[0]
        }

        timeline.push(pre_second_move);

        var second_move = {
          type: "image-slider-response",
          stimulus: "figures/sticks" + (10 * agent1stick) + "and" + (10 * agent2stick) + ".png",
          prompt:
            "<p>Now, the red contestant shows a stick of length " +
            (10 * agent1stick) + "in from the set.</p>" +
            "<p>Is the average stick length for all five sticks more likely to " +
            "be longer or shorter than 5in?</p>",
          labels: ['Definitely shorter', 'Definitely longer'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true,
          data: {
            stimulus_type: 'isLong',
            stimulus_contestant: 'second'
          }
        };

        timeline.push(second_move);

        var final_decision = {
          type: "image-button-response",
          stimulus: "figures/sticks" + (10 * agent1stick) + "and" + (10 * agent2stick) + ".png",
          prompt:
            "<p>Do you think that the average of the five sticks is longer than " +
            "or shorter than 5in?</p>",
          choices: ['Shorter than 5in', 'Longer than 5in'],
          data: {
            stimulus_type: '2afc'
          }
        };

        timeline.push(final_decision);

        // Allows us to measure the strong evidence effect for listeners.
        var post_first_move = {
          type: "image-slider-response",
          stimulus: "figures/stick" + (10 * agent2stick) + "grey.png",
          prompt:
            "<p>How biased is the blue contestant?</p>",
          labels: ['Biased towards showing shorter sticks',
                    'Showing sticks at random',
                    'Biased towards showing longer sticks'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true,
          data: {
            stimulus_type: 'bias',
            stimulus_contestant: 'first'
          }
        };

        timeline.push(post_first_move);

        // Allows us to measure the strong evidence effect for listeners.
        var post_second_move = {
          type: "image-slider-response",
          stimulus: "figures/sticks" + (10 * agent1stick) + "and" + (10 * agent2stick) + "grey.png",
          prompt:
            "<p>How biased is the red contestant?</p>",
          labels: ['Biased towards showing shorter sticks',
                    'Showing sticks at random',
                    'Biased towards showing longer sticks'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true,
          data: {
            stimulus_type: 'bias',
            stimulus_contestant: 'second'
          }
        };

        timeline.push(post_second_move);

        var exit_survey = {
          type: 'survey-text',
          questions: [
            {prompt: "Do you have any comments or suggestions?"}
          ],
          data: {
            stimulus_type: 'exit_survey'
          }
        };

        timeline.push(exit_survey)

        var goodbye = {
          type: 'html-keyboard-response',
          stimulus: 'Thank you for participating! Press any key to exit.'
        }

        timeline.push(goodbye);

        // Store experiment parameter settings in the data.
        jsPsych.data.addProperties({
          numSticks: numSticks,
          agentBias: agentBias,
          agent1stick: agent1stick,
          agent2stick: agent2stick
        });

        jsPsych.init({
          timeline: timeline,
          on_finish : function(data) {
            // At the end of the experiment, submit to turk
            // Record number of quiz attempts
            jsPsych.data.addProperties({quizAttempts: quizAttempts});
            console.log('sending data to mturk');
            jsPsych.turk.submitToTurk({'value': 0});
            // jsPsych.data.displayData('csv'); // Uncomment this line to debug
          },
          on_trial_finish: function(trialData) {
            // At the end of each trial, send data to server
            var packet = Object.assign({}, mongoData, trialData, {
              dbname: 'bayesian-persuasion',
              colname: 'experiment1',
              wID: turkInfo.workerId,
              aID: turkInfo.assignmentId,
              hitID: turkInfo.hitId,
              iterationName: iterationName
            })
            socket.emit('currentData', packet);
          }
        });

      });
    }
    </script>
</html>
